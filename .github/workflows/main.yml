name: Deploy Symfony to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy and setup server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ sercrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ sercrets.PRIVATE_KEY }}
        script: |
          # Mise à jour du système
          sudo apt update && sudo apt upgrade -y

          # Installation de PHP 8.2 et extensions nécessaires
          sudo apt install -y software-properties-common
          sudo add-apt-repository ppa:ondrej/php -y
          sudo apt update
          sudo apt install -y php8.2 php8.2-fpm php8.2-cli php8.2-common php8.2-mysql php8.2-xml php8.2-curl php8.2-gd php8.2-mbstring php8.2-zip php8.2-intl php8.2-bcmath

          # Installation de Composer
          if ! command -v composer &> /dev/null; then
            curl -sS https://getcomposer.org/installer | php
            sudo mv composer.phar /usr/local/bin/composer
            sudo chmod +x /usr/local/bin/composer
          fi

          # Installation de Git si pas présent
          sudo apt installer -y git

          # Installation de Nginx
          sudo apt install -y nginx

          # Installation de Certbot pour SSL
          sudo apt install -y certbot python3-certbot-nginx

          # Clonage ou mise à jour du projet
          if [ -d "/app/portfolio" ]; then
            cd /app/portfolio
            git pull origin main
          else
            cd /app
            git clone https://github.com/TYrueouJeL/Portfolio.git portfolio
            cd /app/portfolio
          fi

          # Installation des dépendances Composer
          composer install --no-dev --optimize-autoloader

          # Configuration des permissions
          sudo chown -R www-data:www-data /app/portfolio/var
          sudo chmod -R 775 /app/portfolio/var

          # Nettoyage du cache Symfony
          php bin/console cache:clear --env-prod

          # Configuration Nginx pour Symfony
          sudo tee /etc/nginx/sites-available/remiguerin.fr > /dev/null <<EOF
          server {
            listen 80;
            server_name remiguerin.fr www.remiguerin.fr;
            root /app/portfolio/public;
            index index.php;

            # Security headers
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header X-Content-Type-Options "nosniff" always;

            location / {
              try_files \$uri /index.php\$is_args\$args;
            }

            location ~ ^/index\.php(/|$) {
              fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
              fastcgi_split_path_info ^(.+\.php)(/.*)$;
              include fastcgi_params;
              fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
              fastcgi_param DOCUMENT_ROOT \$realpath_root;
              fastcgi_param HTTPS off;
              internal;
            }

            location ~ \.php$ {
              return 404;
            }

            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
              expires 1y;
              add_header Cache-Control "public, immutable";
            }

            location ~ /\. {
              deny all;
            }
          }
          EOF

          # Activation du site
          sudo ln -sf /etc/nginx/sites-available/remiguerin.fr /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default

          # Test et redémarrage des services
          sudo nginx -t
          sudo systemctl restart nginx
          sudo systemctl restart php8.2-fpm

          # Activation des services au démarrage
          sudo systemctl enable nginx
          sudo systemctl enable php8.2-fpm

          echo "Déploiement terminé ! Votre site Symfony est accessible sur remiguerin.fr"
